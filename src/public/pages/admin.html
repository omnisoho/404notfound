<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin Dashboard — Kōsui</title>
    <link rel="stylesheet" href="../styles/output.css" />
    <link rel="stylesheet" href="../styles/admin.css" />
  </head>
  <body class="min-h-screen bg-canvas font-sans text-ink antialiased">
    <!-- Header - Same structure as home.html -->
    <header
      id="mainHeader"
      class="fade-in-initial border-b-2 border-ink/10"
    >
        <div class="flex items-baseline gap-3">
          <p class="font-display text-2xl font-medium tracking-tight">Kōsui</p>
        </div>
        <nav
          class="flex items-center justify-center gap-2 text-[0.65rem] font-medium uppercase tracking-[0.4em]"
        >
          <a
            href="/home"
            class="px-5 py-2.5 text-muted transition-all duration-300 hover:text-ink"
            >Home</a
          >
          <a
            href="/main_dashboard"
            class="px-5 py-2.5 text-muted transition-all duration-300 hover:text-ink"
            >Dashboard</a
          >
          <a
            href="/admin"
            class="px-5 py-2.5 text-ink transition-all duration-300"
            >Admin</a
          >
        </nav>
        <div class="relative">
          <div
            id="userChip"
            class="flex cursor-pointer items-center gap-2.5 border-l-2 border-ink/10 pl-6"
          >
            <div class="text-right leading-tight">
              <p id="userName" class="text-sm font-semibold">Admin</p>
              <small
                class="text-[0.65rem] uppercase tracking-[0.3em] text-muted"
              >
                <span id="userTimezone">GMT+8</span>
              </small>
            </div>
            <div
              id="userAvatar"
              class="flex h-8 w-8 items-center justify-center border-2 border-navy bg-navy font-mono text-xs font-bold text-sheet"
            >
              AD
            </div>
          </div>

          <!-- User Dropdown Menu -->
          <div
            id="userDropdown"
            class="invisible absolute right-0 top-full z-[100] mt-3 opacity-0"
          >
            <div>
              <div
                class="dropdown-item"
                data-action="profile"
              >
                <i data-lucide="user"></i>
                <span>Profile</span>
              </div>
              <div
                class="dropdown-item"
                data-action="settings"
              >
                <i data-lucide="settings"></i>
                <span>Settings</span>
              </div>
            </div>
            <div class="dropdown-divider"></div>
            <div>
              <div
                class="dropdown-item"
                data-action="logout"
              >
                <i data-lucide="log-out"></i>
                <span>Sign Out</span>
              </div>
            </div>
          </div>
      </div>
    </header>

    <!-- Main Container -->
    <div class="mx-auto max-w-7xl space-y-8 px-5 pb-6" style="margin-top: clamp(5rem, 8vh, 6rem); padding-top: 1.5rem;">
      <!-- Tabs Navigation -->
      <div class="tab-navigation">
        <nav class="tab-list">
          <button
            class="tab-button active"
            data-tab="overview"
            aria-selected="true"
            role="tab"
          >
            Overview
          </button>
          <button
            class="tab-button"
            data-tab="users"
            aria-selected="false"
            role="tab"
          >
            Users
          </button>
          <a 
            href="/analytics" 
            class="tab-button" 
            style="text-decoration: none; display: inline-flex; align-items: center; justify-content: center;"
          >
            Analytics
          </a>

        </nav>
      </div>

      <!-- Tab Contents -->
      
      <!-- Overview Tab -->
      <div id="overviewTab" class="tab-content active">
        <!-- Quick Stats -->
        <section class="scroll-reveal delay-100 mb-12 grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
          <article class="stat-card space-y-2 border border-border bg-sheet p-5">
            <p class="text-[0.65rem] uppercase tracking-[0.4em] text-muted">
              Total Users
            </p>
            <p id="statTotalUsers" class="font-display text-3xl font-semibold">
              —
            </p>
            <p class="text-xs text-muted" id="statTotalUsersDetail">All registered accounts</p>
          </article>
          <article class="stat-card space-y-2 border border-border bg-sheet p-5">
            <p class="text-[0.65rem] uppercase tracking-[0.4em] text-muted">
              Active (30D)
            </p>
            <p id="statActiveUsers" class="font-display text-3xl font-semibold">
              —
            </p>
            <p class="text-xs text-muted" id="statActiveUsersDetail">Users active in last 30 days</p>
          </article>
          <article class="stat-card space-y-2 border border-border bg-sheet p-5">
            <p class="text-[0.65rem] uppercase tracking-[0.4em] text-muted">
              Total Trips
            </p>
            <p id="statTotalTrips" class="font-display text-3xl font-semibold">
              —
            </p>
            <p class="text-xs text-muted" id="statTotalTripsDetail">Itineraries created by users</p>
          </article>
          <article class="stat-card space-y-2 border border-border bg-sheet p-5">
            <p class="text-[0.65rem] uppercase tracking-[0.4em] text-muted">
              Quiz Rate
            </p>
            <p id="statQuizCompletions" class="font-display text-3xl font-semibold">
              —
            </p>
            <p class="text-xs text-muted" id="statQuizCompletionsDetail">Personality quiz completions</p>
          </article>
        </section>

        <!-- Recent Users -->
        <section class="scroll-reveal delay-200 mb-12">
          <div class="mb-8 flex items-end justify-between border-b border-border pb-4">
            <div>
              <p class="mb-2 text-xs font-medium uppercase tracking-[0.4em] text-muted">
                User Activity
              </p>
              <h2 class="font-display text-2xl font-semibold tracking-tight">
                Recent Users
              </h2>
            </div>
            <button
              onclick="switchTab('users')"
              class="border border-navy bg-navy px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-sheet transition-all duration-300 hover:bg-transparent hover:text-navy"
            >
              View All
            </button>
          </div>
          <div id="recentUsersContainer" class="space-y-0">
            <div class="flex items-center justify-center py-12 text-muted">
              <p>Loading recent users...</p>
            </div>
          </div>
        </section>

        <!-- System Overview Grid -->
        <section class="scroll-reveal delay-300">
          <div class="grid gap-6 lg:grid-cols-3">
            <!-- System Status -->
            <div class="border border-border bg-sheet p-6">
              <h3 class="mb-4 text-sm uppercase tracking-[0.4em] text-muted">System Status</h3>
              <div class="space-y-4">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <div id="statusDatabase" class="h-2.5 w-2.5 rounded-full bg-emerald-500 shadow-[0_0_0_3px_rgba(16,185,129,0.15)]"></div>
                    <span class="text-sm font-medium">Database</span>
                  </div>
                  <span id="statusDatabaseText" class="text-xs text-muted">Checking...</span>
                </div>
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <div id="statusAPI" class="h-2.5 w-2.5 rounded-full bg-emerald-500 shadow-[0_0_0_3px_rgba(16,185,129,0.15)]"></div>
                    <span class="text-sm font-medium">API</span>
                  </div>
                  <span id="statusAPIText" class="text-xs text-muted">Checking...</span>
                </div>
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <div id="statusAuth" class="h-2.5 w-2.5 rounded-full bg-emerald-500 shadow-[0_0_0_3px_rgba(16,185,129,0.15)]"></div>
                    <span class="text-sm font-medium">Auth Service</span>
                  </div>
                  <span id="statusAuthText" class="text-xs text-muted">Checking...</span>
                </div>
              </div>
            </div>

            <!-- Platform Metrics -->
            <div class="border border-border bg-sheet p-6">
              <h3 class="mb-4 text-sm uppercase tracking-[0.4em] text-muted">Platform Metrics</h3>
              <div class="space-y-4">
                <div>
                  <p class="text-xs text-muted">Avg Trips/User</p>
                  <p id="statAvgTrips" class="mt-1 font-display text-2xl font-semibold">—</p>
                </div>
                <div>
                  <p class="text-xs text-muted">New Users (Today)</p>
                  <p id="statNewToday" class="mt-1 font-display text-2xl font-semibold">—</p>
                </div>
              </div>
            </div>

            <!-- Quick Actions -->
            <div class="border border-border bg-sheet p-6">
              <h3 class="mb-4 text-sm uppercase tracking-[0.4em] text-muted">Quick Actions</h3>
              <div class="space-y-3">
                <button
                  onclick="switchTab('users')"
                  class="w-full border border-navy bg-navy px-4 py-3 text-xs uppercase tracking-[0.3em] text-white transition-all duration-300 hover:bg-transparent hover:text-navy"
                >
                  Manage Users
                </button>
                <div class="pt-3">
                  <p class="text-xs text-muted">Total Personas</p>
                  <p id="statTotalPersonas" class="mt-1 font-display text-2xl font-semibold">—</p>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- Users Tab -->
      <div id="usersTab" class="tab-content" style="position: relative; overflow: visible;">
        <!-- Filters and Search - Notion Filter Bar Style -->
        <div style="margin-bottom: 1.5rem; padding-top: 4px; position: relative; z-index: 1; clear: both; overflow: visible; background: transparent;">
          <div style="display: flex; position: relative;">
            <!-- Filter Scroll Container -->
            <div style="position: relative; flex-grow: 0; overflow: visible; flex: 1; min-width: 0;">
              <div class="notion-filter-scroller" style="display: flex; align-items: center; padding-top: 8px; padding-bottom: 8px; overflow: visible; scrollbar-width: none; -ms-overflow-style: none;">
                <div style="display: contents;">
                  <!-- Active Filters Container -->
                  <div id="activeFiltersContainer" style="display: flex; align-items: center; gap: 6px; flex-wrap: nowrap; margin-right: 12px;">
                    <!-- Active filters will be rendered here as pills -->
                  </div>
                  
                  <!-- Add Filter Button -->
                  <div style="display: contents;">
                    <div style="position: relative; z-index: 1000;">
                      <button
                        id="addFilterBtn"
                        type="button"
                        class="notion-filter-add-btn"
                        style="user-select: none; transition: background 150ms cubic-bezier(0.16, 1, 0.3, 1), transform 150ms cubic-bezier(0.16, 1, 0.3, 1); cursor: pointer; opacity: 1; display: inline-flex; align-items: center; justify-content: center; gap: 4px; height: 24px; padding: 0 8px; border-radius: 12px; white-space: nowrap; font-size: 14px; font-weight: 400; line-height: 1.2; color: var(--muted); flex-shrink: 0; min-width: 0px; background: transparent; border: none;"
                      >
                        <svg aria-hidden="true" role="graphics-symbol" viewBox="0 0 16 16" style="width: 14px; height: 14px; display: block; fill: inherit; flex-shrink: 0; color: inherit;">
                          <path d="M8 2.74a.66.66 0 0 1 .66.66v3.94h3.94a.66.66 0 0 1 0 1.32H8.66v3.94a.66.66 0 0 1-1.32 0V8.66H3.4a.66.66 0 0 1 0-1.32h3.94V3.4A.66.66 0 0 1 8 2.74"></path>
                        </svg>
                        <span>Filter</span>
                      </button>
                      
                      <!-- Filter Dropdown (hidden by default) - Notion Style -->
                      <div id="filterDropdown" class="hidden" style="display: none; position: fixed; z-index: 999999; background: var(--sheet); border: 1px solid var(--border); border-radius: 10px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12), 0 2px 8px rgba(0, 0, 0, 0.08); width: 265px; opacity: 0; transform: translateY(-4px) scale(0.98); transition: opacity 200ms cubic-bezier(0.16, 1, 0.3, 1), transform 200ms cubic-bezier(0.16, 1, 0.3, 1); pointer-events: none;">
                        <!-- Role Filter Section -->
                        <div style="gap: 1px; padding: 8px 4px 4px; display: flex; flex-direction: column;">
                          <div style="display: flex; padding-inline: 8px; margin-bottom: 8px; color: var(--muted); font-size: 12px; font-weight: 500; line-height: 120%; user-select: none;">
                            <div style="white-space: nowrap;">Filter by Role</div>
                          </div>
                          <div role="option" tabindex="0" class="filter-dropdown-item" data-filter-type="role" data-role-value="" style="user-select: none; transition: background 20ms ease-in; cursor: pointer; width: 100%; display: flex; border-radius: 6px;">
                            <div style="display: flex; align-items: center; gap: 8px; line-height: 120%; width: 100%; min-height: 28px; font-size: 14px; padding-inline: 8px;">
                              <div style="display: flex; align-items: center; justify-content: center; min-width: 20px; min-height: 20px;">
                                <i data-lucide="users" style="width: 16px; height: 16px; color: var(--muted);"></i>
                              </div>
                              <div style="flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">All Roles</div>
                            </div>
                          </div>
                          <div role="option" tabindex="0" class="filter-dropdown-item" data-filter-type="role" data-role-value="user" style="user-select: none; transition: background 20ms ease-in; cursor: pointer; width: 100%; display: flex; border-radius: 6px;">
                            <div style="display: flex; align-items: center; gap: 8px; line-height: 120%; width: 100%; min-height: 28px; font-size: 14px; padding-inline: 8px;">
                              <div style="display: flex; align-items: center; justify-content: center; min-width: 20px; min-height: 20px;">
                                <i data-lucide="user" style="width: 16px; height: 16px; color: rgb(59, 130, 246);"></i>
                              </div>
                              <div style="flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">User</div>
                            </div>
                          </div>
                          <div role="option" tabindex="0" class="filter-dropdown-item" data-filter-type="role" data-role-value="admin" style="user-select: none; transition: background 20ms ease-in; cursor: pointer; width: 100%; display: flex; border-radius: 6px;">
                            <div style="display: flex; align-items: center; gap: 8px; line-height: 120%; width: 100%; min-height: 28px; font-size: 14px; padding-inline: 8px;">
                              <div style="display: flex; align-items: center; justify-content: center; min-width: 20px; min-height: 20px;">
                                <i data-lucide="shield" style="width: 16px; height: 16px; color: rgb(139, 92, 246);"></i>
                              </div>
                              <div style="flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Admin</div>
                            </div>
                          </div>
                          <div role="option" tabindex="0" class="filter-dropdown-item" data-filter-type="role" data-role-value="premium" style="user-select: none; transition: background 20ms ease-in; cursor: pointer; width: 100%; display: flex; border-radius: 6px;">
                            <div style="display: flex; align-items: center; gap: 8px; line-height: 120%; width: 100%; min-height: 28px; font-size: 14px; padding-inline: 8px;">
                              <div style="display: flex; align-items: center; justify-content: center; min-width: 20px; min-height: 20px;">
                                <i data-lucide="star" style="width: 16px; height: 16px; color: rgb(251, 191, 36);"></i>
                              </div>
                              <div style="flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Premium</div>
                            </div>
                          </div>
                        </div>

                        <!-- Divider -->
                        <div style="position: relative; margin-top: 1px;">
                          <div style="position: absolute; top: -1px; left: 12px; right: 12px; height: 1px; background: var(--border);"></div>
                        </div>

                        <!-- Date Filter Section -->
                        <div style="gap: 1px; padding: 8px 4px; display: flex; flex-direction: column; margin-top: 1px;">
                          <div style="display: flex; padding-inline: 8px; margin-bottom: 8px; color: var(--muted); font-size: 12px; font-weight: 500; line-height: 120%; user-select: none;">
                            <div style="white-space: nowrap;">Filter by Date</div>
                          </div>
                          <div role="option" tabindex="0" class="filter-dropdown-item" data-filter-type="dateRange" data-date-value="" style="user-select: none; transition: background 20ms ease-in; cursor: pointer; width: 100%; display: flex; border-radius: 6px;">
                            <div style="display: flex; align-items: center; gap: 8px; line-height: 120%; width: 100%; min-height: 28px; font-size: 14px; padding-inline: 8px;">
                              <div style="display: flex; align-items: center; justify-content: center; min-width: 20px; min-height: 20px;">
                                <i data-lucide="infinity" style="width: 16px; height: 16px; color: var(--muted);"></i>
                              </div>
                              <div style="flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">All Time</div>
                            </div>
                          </div>
                          <div role="option" tabindex="0" class="filter-dropdown-item" data-filter-type="dateRange" data-date-value="7d" style="user-select: none; transition: background 20ms ease-in; cursor: pointer; width: 100%; display: flex; border-radius: 6px;">
                            <div style="display: flex; align-items: center; gap: 8px; line-height: 120%; width: 100%; min-height: 28px; font-size: 14px; padding-inline: 8px;">
                              <div style="display: flex; align-items: center; justify-content: center; min-width: 20px; min-height: 20px;">
                                <i data-lucide="calendar" style="width: 16px; height: 16px; color: var(--muted);"></i>
                              </div>
                              <div style="flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Last 7 Days</div>
                            </div>
                          </div>
                          <div role="option" tabindex="0" class="filter-dropdown-item" data-filter-type="dateRange" data-date-value="30d" style="user-select: none; transition: background 20ms ease-in; cursor: pointer; width: 100%; display: flex; border-radius: 6px;">
                            <div style="display: flex; align-items: center; gap: 8px; line-height: 120%; width: 100%; min-height: 28px; font-size: 14px; padding-inline: 8px;">
                              <div style="display: flex; align-items: center; justify-content: center; min-width: 20px; min-height: 20px;">
                                <i data-lucide="calendar" style="width: 16px; height: 16px; color: var(--muted);"></i>
                              </div>
                              <div style="flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Last 30 Days</div>
                            </div>
                          </div>
                          <div role="option" tabindex="0" class="filter-dropdown-item" data-filter-type="dateRange" data-date-value="90d" style="user-select: none; transition: background 20ms ease-in; cursor: pointer; width: 100%; display: flex; border-radius: 6px;">
                            <div style="display: flex; align-items: center; gap: 8px; line-height: 120%; width: 100%; min-height: 28px; font-size: 14px; padding-inline: 8px;">
                              <div style="display: flex; align-items: center; justify-content: center; min-width: 20px; min-height: 20px;">
                                <i data-lucide="calendar" style="width: 16px; height: 16px; color: var(--muted);"></i>
                              </div>
                              <div style="flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Last 90 Days</div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Search Input - Notion Style -->
            <div style="display: flex; align-items: center; padding-top: 8px; margin-left: auto; flex-shrink: 0;">
              <div style="position: relative;">
                <div style="position: relative; display: flex; align-items: center;">
                  <i data-lucide="search" style="position: absolute; left: 10px; width: 16px; height: 16px; color: var(--muted); pointer-events: none; z-index: 1;"></i>
                  <input
                    type="text"
                    id="userSearch"
                    placeholder="Search users..."
                    style="width: 280px; padding: 7px 12px 7px 36px; font-size: 14px; line-height: 20px; border: 1px solid var(--border); border-radius: 6px; background: var(--sheet); color: var(--ink); transition: all 150ms ease; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; outline: none;"
                    onfocus="this.style.borderColor='var(--navy)'; this.style.boxShadow='0 0 0 3px rgba(30, 58, 95, 0.1)'"
                    onblur="this.style.borderColor='var(--border)'; this.style.boxShadow='none'"
                  />
                </div>
              </div>
            </div>
          </div>
          
          <!-- Hidden filter controls for programmatic access -->
          <select id="userRoleFilter" class="hidden">
            <option value="">All roles</option>
            <option value="user">User</option>
            <option value="admin">Admin</option>
            <option value="premium">Premium</option>
          </select>
          <select id="userDateFilter" class="hidden">
            <option value="">All time</option>
            <option value="7d">Last 7 days</option>
            <option value="30d">Last 30 days</option>
            <option value="90d">Last 90 days</option>
          </select>

          <!-- Bulk Actions Bar (shown when users are selected) -->
          <div id="bulkActionsBar" class="hidden mt-4 pt-3 border-t border-[var(--border)] items-center justify-between" style="padding-top: 12px; margin-top: 1.5rem; opacity: 0; max-height: 0; overflow: hidden; transform: translateY(-12px);">
            <div class="flex items-center gap-3">
              <span id="selectedCount" class="text-sm font-medium text-[var(--navy)]">0 selected</span>
            </div>
            <div class="flex items-center gap-2">
              <button
                id="bulkDeleteBtn"
                class="px-3 py-1.5 text-sm font-medium text-red-600 hover:bg-red-50 rounded-md transition-colors flex items-center gap-2"
              >
                <i data-lucide="trash-2" class="h-3.5 w-3.5"></i>
                Delete
              </button>
              <button
                id="bulkResetPasswordBtn"
                class="px-3 py-1.5 text-sm font-medium text-amber-600 hover:bg-amber-50 rounded-md transition-colors flex items-center gap-2"
              >
                <i data-lucide="key" class="h-3.5 w-3.5"></i>
                Reset Password
              </button>
              <button
                id="clearSelectionBtn"
                class="px-3 py-1.5 text-sm font-medium text-[var(--muted)] hover:bg-[var(--canvas)] rounded-md transition-colors"
              >
                Clear
              </button>
            </div>
          </div>
        </div>

        <!-- Users Table Container - Notion Style -->
        <div style="position: relative; width: 100%; margin-top: 0;">
          <div class="notion-table-view">
          <!-- Header Row -->
          <div class="notion-table-view-header-row">
            <!-- Checkbox Column Header (Sticky) -->
            <div class="notion-table-view-checkbox-column" style="position: sticky; left: 0px; z-index: 87; background: var(--canvas); width: 40px; min-width: 40px; flex-shrink: 0;">
              <div style="height: 100%; display: flex; align-items: center; justify-content: center; padding: 0 12px;">
                <div class="notion-table-view-checkbox-input" id="selectAllCheckbox" onclick="event.stopPropagation(); toggleSelectAll()" style="cursor: pointer;">
                  <input type="checkbox" id="selectAllCheckboxInput" style="position: absolute; opacity: 0; width: 16px; height: 16px; top: 0; left: 0; cursor: pointer; z-index: 10; margin: 0;">
                  <div class="notion-table-view-checkbox-checkmark">
                    <svg viewBox="0 0 16 16" fill="none" stroke="currentColor">
                      <path d="M4 8l2.5 2.5L12 5" stroke-linecap="round" stroke-linejoin="round"></path>
                    </svg>
                  </div>
                </div>
              </div>
            </div>

            <!-- Name Header -->
            <div class="notion-table-view-header-cell" style="width: 200px;" data-sort-column="name">
              <div role="button" tabindex="0" onclick="handleColumnSort('name')">
                <div class="notion-table-view-header-cell-content">
                  <div class="notion-table-view-header-cell-icon">
                    <i data-lucide="user" class="h-4 w-4"></i>
                  </div>
                  <div class="notion-table-view-header-cell-text">Name</div>
                </div>
              </div>
            </div>

            <!-- Email Header -->
            <div class="notion-table-view-header-cell" style="width: 220px;" data-sort-column="email">
              <div role="button" tabindex="0" onclick="handleColumnSort('email')">
                <div class="notion-table-view-header-cell-content">
                  <div class="notion-table-view-header-cell-icon">
                    <i data-lucide="mail" class="h-4 w-4"></i>
                  </div>
                  <div class="notion-table-view-header-cell-text">Email</div>
                </div>
              </div>
            </div>

            <!-- Role Header -->
            <div class="notion-table-view-header-cell" style="width: 100px;" data-sort-column="userRole">
              <div role="button" tabindex="0" onclick="handleColumnSort('userRole')">
                <div class="notion-table-view-header-cell-content">
                  <div class="notion-table-view-header-cell-icon">
                    <i data-lucide="shield" class="h-4 w-4"></i>
                  </div>
                  <div class="notion-table-view-header-cell-text">Role</div>
                </div>
              </div>
            </div>

            <!-- Joined Date Header -->
            <div class="notion-table-view-header-cell" style="width: 140px;" data-sort-column="createdAt">
              <div role="button" tabindex="0" onclick="handleColumnSort('createdAt')">
                <div class="notion-table-view-header-cell-content">
                  <div class="notion-table-view-header-cell-icon">
                    <i data-lucide="calendar" class="h-4 w-4"></i>
                  </div>
                  <div class="notion-table-view-header-cell-text">Joined</div>
                </div>
              </div>
            </div>

            <!-- Status Header (not sortable) -->
            <div class="notion-table-view-header-cell" style="width: 100px;">
              <div>
                <div class="notion-table-view-header-cell-content">
                  <div class="notion-table-view-header-cell-icon">
                    <i data-lucide="circle" class="h-3 w-3"></i>
                  </div>
                  <div class="notion-table-view-header-cell-text">Status</div>
                </div>
              </div>
            </div>

            <!-- Updated Header -->
            <div class="notion-table-view-header-cell" style="width: 120px;" data-sort-column="updatedAt">
              <div role="button" tabindex="0" onclick="handleColumnSort('updatedAt')">
                <div class="notion-table-view-header-cell-content">
                  <div class="notion-table-view-header-cell-icon">
                    <i data-lucide="clock" class="h-4 w-4"></i>
                  </div>
                  <div class="notion-table-view-header-cell-text">Updated</div>
                </div>
              </div>
            </div>

            <!-- Trips Header (not sortable - would need backend support) -->
            <div class="notion-table-view-header-cell" style="width: 80px;">
              <div>
                <div class="notion-table-view-header-cell-content">
                  <div class="notion-table-view-header-cell-icon">
                    <i data-lucide="map" class="h-4 w-4"></i>
                  </div>
                  <div class="notion-table-view-header-cell-text">Trips</div>
                </div>
              </div>
            </div>

            <!-- Provider Header -->
            <div class="notion-table-view-header-cell" style="width: 90px;" data-sort-column="authProvider">
              <div role="button" tabindex="0" onclick="handleColumnSort('authProvider')">
                <div class="notion-table-view-header-cell-content">
                  <div class="notion-table-view-header-cell-icon">
                    <i data-lucide="key-round" class="h-4 w-4"></i>
                  </div>
                  <div class="notion-table-view-header-cell-text">Provider</div>
                </div>
              </div>
            </div>

            <!-- Actions Header -->
            <div class="notion-table-view-header-cell" style="flex-grow: 1; min-width: 120px;">
              <div>
                <div class="notion-table-view-header-cell-content" style="justify-content: center;">
                  <div class="notion-table-view-header-cell-text">Actions</div>
                </div>
              </div>
            </div>
          </div>

          <!-- User Rows Container -->
          <div id="usersTableBody">
            <!-- Loading state -->
            <div style="display: flex; width: 100%; border-bottom: 1px solid var(--border); padding: 3rem 0;">
              <div style="width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.5rem;">
                <div class="spinner"></div>
                <p style="color: var(--muted); font-size: 0.875rem;">Loading users...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Pagination -->
        <div class="px-6 py-4 bg-[var(--canvas)] border-t border-[var(--border)] flex items-center justify-between mt-0">
          <div class="text-sm text-[var(--muted)]">
            Showing <span id="paginationStart">0</span> to <span id="paginationEnd">0</span> of <span id="paginationTotal">0</span> users
          </div>
          <div class="flex gap-2">
            <button
              id="prevPageBtn"
              class="px-3 py-1 border border-[var(--border)] rounded-md hover:bg-[var(--sheet)] transition-colors text-sm disabled:opacity-50 disabled:cursor-not-allowed"
              disabled
            >
              Previous
            </button>
            <button
              id="nextPageBtn"
              class="px-3 py-1 border border-[var(--border)] rounded-md hover:bg-[var(--sheet)] transition-colors text-sm disabled:opacity-50 disabled:cursor-not-allowed"
              disabled
            >
              Next
            </button>
          </div>
        </div>
      </div>

      <!-- Analytics Tab -->
      <div id="analyticsTab" class="tab-content">
        <div style="display: flex; flex-direction: column; gap: 24px;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2 style="font-size: 20px; font-weight: 600; color: var(--ink);">Analytics Dashboard</h2>
            <select id="analyticsDateRange" style="padding: 6px 32px 6px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; color: var(--ink); background: var(--sheet); cursor: pointer; appearance: none; background-image: url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2712%27 height=%278%27 viewBox=%270 0 12 8%27%3e%3cpath fill=%27%23374151%27 d=%27M1.41 0L6 4.59 10.59 0 12 1.42l-6 6-6-6z%27/%3e%3c/svg%3e'); background-repeat: no-repeat; background-position: right 10px center;">
              <option value="7d">Last 7 days</option>
              <option value="30d" selected>Last 30 days</option>
              <option value="90d">Last 90 days</option>
              <option value="365d">Last year</option>
              <option value="all">All time</option>
            </select>
          </div>

          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px;">
            <div style="background: var(--sheet); border: 1px solid var(--border); border-radius: 8px; padding: 20px;">
              <h3 style="font-size: 16px; font-weight: 600; color: var(--ink); margin-bottom: 16px;">User Growth Over Time</h3>
              <div style="position: relative; height: 300px;">
                <canvas id="userGrowthChart"></canvas>
              </div>
            </div>

            <div style="background: var(--sheet); border: 1px solid var(--border); border-radius: 8px; padding: 20px;">
              <h3 style="font-size: 16px; font-weight: 600; color: var(--ink); margin-bottom: 16px;">User Role Distribution</h3>
              <div style="position: relative; height: 300px;">
                <canvas id="roleDistributionChart"></canvas>
              </div>
            </div>

            <div style="background: var(--sheet); border: 1px solid var(--border); border-radius: 8px; padding: 20px;">
              <h3 style="font-size: 16px; font-weight: 600; color: var(--ink); margin-bottom: 16px;">Personality Distribution</h3>
              <div style="position: relative; height: 300px;">
                <canvas id="personaDistributionChart"></canvas>
              </div>
            </div>

            <div style="background: var(--sheet); border: 1px solid var(--border); border-radius: 8px; padding: 20px;">
              <h3 style="font-size: 16px; font-weight: 600; color: var(--ink); margin-bottom: 16px;">Trip Creation Over Time</h3>
              <div style="position: relative; height: 300px;">
                <canvas id="dailySignupsChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Message Container -->
    <div id="messageContainer" class="fixed top-24 right-5 z-50 max-w-sm"></div>

    <!-- Dropdown backdrop -->
    <div id="userDropdownBackdrop" class="fixed inset-0 z-50 hidden"></div>

    <!-- Edit User Modal - Notion Style -->
    <div id="editUserModal" class="modal-overlay hidden">
      <div class="modal-container">
        <div class="modal-header">
          <h3 class="modal-title">Edit user</h3>
          <button type="button" id="closeEditUserModal" class="modal-close-btn">
            <i data-lucide="x" class="h-4 w-4"></i>
          </button>
        </div>
        <form id="editUserForm" class="modal-body" style="padding: 16px;">
          <input type="hidden" id="editUserId" value="">
          <div class="modal-field">
            <label for="editUserName" class="modal-label">Name</label>
            <input
              type="text"
              id="editUserName"
              class="modal-input"
              placeholder="Enter name"
              required
            />
          </div>
          <div class="modal-field">
            <label for="editUserEmail" class="modal-label">Email</label>
            <input
              type="email"
              id="editUserEmail"
              class="modal-input"
              placeholder="Enter email"
              required
            />
          </div>
          <div class="modal-field" style="margin-bottom: 0;">
            <label class="modal-label">Role</label>
            <div class="custom-role-selector">
              <button type="button" class="custom-role-selector-button" id="roleDropdownButton">
                <span id="roleDropdownSelected">
                  <span class="role-selector-badge user">User</span>
                </span>
                <svg width="10" height="10" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="2 4 6 8 10 4"></polyline>
                </svg>
              </button>
              <div class="custom-role-selector-dropdown" id="roleDropdown">
                <div class="custom-role-selector-option selected" data-role="user">
                  <span class="role-selector-badge user">User</span>
                </div>
                <div class="custom-role-selector-option" data-role="admin">
                  <span class="role-selector-badge admin">Admin</span>
                </div>
                <div class="custom-role-selector-option" data-role="premium">
                  <span class="role-selector-badge premium">Premium</span>
                </div>
              </div>
            </div>
            <input type="hidden" id="editUserRole" value="user">
          </div>
        </form>
        <div class="modal-footer">
          <button
            type="button"
            id="cancelEditUser"
            class="modal-btn-secondary"
          >
            Cancel
          </button>
          <button
            type="submit"
            form="editUserForm"
            class="modal-btn-primary"
          >
            Save
          </button>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal - Notion Style -->
    <div id="deleteUserModal" class="modal-overlay hidden">
      <input type="hidden" id="deleteUserId" value="">
      <div class="modal-container" style="max-width: 400px;">
        <div class="modal-header">
          <h3 class="modal-title">Delete user</h3>
          <button type="button" id="closeDeleteUserModal" class="modal-close-btn">
            <i data-lucide="x" class="h-4 w-4"></i>
          </button>
        </div>
        <div class="modal-body" style="padding: 16px;">
          <p style="font-size: 14px; color: rgb(55, 53, 47); line-height: 1.5; margin: 0;">
            Are you sure you want to delete <strong id="deleteUserName"></strong>? This action cannot be undone and will permanently remove all associated data.
          </p>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            id="cancelDeleteUser"
            class="modal-btn-secondary"
          >
            Cancel
          </button>
          <button
            type="button"
            id="confirmDeleteUser"
            class="modal-btn-danger"
          >
            Delete
          </button>
        </div>
      </div>
    </div>

    <!-- Reset Password Modal - Notion Style -->
    <div id="resetPasswordModal" class="modal-overlay hidden">
      <div class="modal-container" style="max-width: 420px;">
        <div class="modal-header">
          <h3 class="modal-title">Password reset</h3>
          <button type="button" id="closeResetPasswordModal" class="modal-close-btn">
            <i data-lucide="x" class="h-4 w-4"></i>
          </button>
        </div>
        <div class="modal-body" style="padding: 16px;">
          <p style="font-size: 14px; color: rgba(55, 53, 47, 0.65); line-height: 1.5; margin: 0 0 12px 0;">
            A temporary password has been generated. Share it securely with the user.
          </p>
          <div class="modal-field" style="margin-bottom: 12px;">
            <label class="modal-label">Temporary Password</label>
            <div style="display: flex; gap: 8px;">
              <input
                type="text"
                id="temporaryPasswordDisplay"
                readonly
                class="modal-input"
                style="flex: 1; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size: 13px;"
                value="********"
              />
              <button
                type="button"
                id="copyPassword"
                class="modal-btn-secondary"
              >
                Copy
              </button>
            </div>
          </div>
          <p style="font-size: 12px; color: rgba(55, 53, 47, 0.5); margin: 0; padding: 8px 0;">
            The user will need to change this password on their next login.
          </p>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            id="closeResetPasswordModalBtn"
            class="modal-btn-primary"
          >
            Done
          </button>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="../vendor/lucide.min.js"></script>
    <script src="../scripts/shared/utils.js"></script>
    <script src="../scripts/shared/constants.js"></script>
    <script src="../scripts/shared/messageManager.js"></script>
    <script>
      // Enhanced tab switching with smooth animations
      function switchTab(tabName) {
        console.log('[switchTab] Switching to tab:', tabName);

        // Get all tabs and buttons
        const allTabs = document.querySelectorAll('.tab-content');
        const allButtons = document.querySelectorAll('.tab-button');
        const targetTab = document.getElementById(tabName + 'Tab');
        const targetButton = document.querySelector(`[data-tab="${tabName}"]`);

        console.log('[switchTab] Target tab found:', !!targetTab, 'Target button found:', !!targetButton);

        if (!targetTab || !targetButton) {
          console.error('[switchTab] Tab or button not found!');
          return;
        }

        // Remove active state from all tabs with fade out
        allTabs.forEach(tab => {
          if (tab.classList.contains('active')) {
            tab.style.animation = 'none';
            // Force reflow
            void tab.offsetHeight;
            tab.classList.remove('active');
          }
          // Force hide all tabs with inline style
          tab.style.display = 'none';
          tab.style.opacity = '0';
        });

        // Remove active state from all buttons
        allButtons.forEach(btn => {
          btn.classList.remove('active');
          btn.setAttribute('aria-selected', 'false');
        });

        // Add active state to selected button
        targetButton.classList.add('active');
        targetButton.setAttribute('aria-selected', 'true');

        // Show selected tab with fade in animation
        requestAnimationFrame(() => {
          // Force display with inline styles to override any CSS
          targetTab.style.display = 'block';
          targetTab.style.opacity = '1';
          targetTab.style.animation = 'tabContentFadeIn 0.4s var(--easing-premium) forwards';
          targetTab.classList.add('active');
          console.log('[switchTab] Activated tab:', tabName, 'Display:', targetTab.style.display, 'Opacity:', targetTab.style.opacity);

          if (tabName === 'users' && typeof window.fetchUsers === 'function') {
            console.log('[switchTab] Loading users data...');
            window.fetchUsers();
          }
          
          if (tabName === 'analytics' && typeof window.fetchAnalytics === 'function') {
            console.log('[switchTab] Loading analytics data...');
            const dateRange = document.getElementById('analyticsDateRange')?.value || '30d';
            window.fetchAnalytics(dateRange);
          }
        });
      }

      // Tab button click handlers with keyboard support
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.addEventListener('click', () => {
          switchTab(btn.dataset.tab);
        });

        // Keyboard navigation
        btn.addEventListener('keydown', (e) => {
          const buttons = Array.from(document.querySelectorAll('.tab-button'));
          const currentIndex = buttons.indexOf(btn);
          
          if (e.key === 'ArrowRight') {
            e.preventDefault();
            const nextIndex = (currentIndex + 1) % buttons.length;
            buttons[nextIndex].focus();
            switchTab(buttons[nextIndex].dataset.tab);
          } else if (e.key === 'ArrowLeft') {
            e.preventDefault();
            const prevIndex = (currentIndex - 1 + buttons.length) % buttons.length;
            buttons[prevIndex].focus();
            switchTab(buttons[prevIndex].dataset.tab);
          } else if (e.key === 'Home') {
            e.preventDefault();
            buttons[0].focus();
            switchTab(buttons[0].dataset.tab);
          } else if (e.key === 'End') {
            e.preventDefault();
            buttons[buttons.length - 1].focus();
            switchTab(buttons[buttons.length - 1].dataset.tab);
          }
        });
      });

      // Set initial active tab
      switchTab('overview');

      // Initialize user dropdown (same as home.js)
      function initializeUserDropdown() {
        const userChip = document.getElementById("userChip");
        const userDropdown = document.getElementById("userDropdown");
        const userDropdownBackdrop = document.getElementById("userDropdownBackdrop");

        if (userChip && userDropdown) {
          userChip.addEventListener("click", (e) => {
            e.stopPropagation();
            const isVisible = !userDropdown.classList.contains("invisible");

            if (isVisible) {
              userDropdown.classList.add("invisible", "opacity-0");
              userDropdown.classList.remove("active");
              if (userDropdownBackdrop) {
                userDropdownBackdrop.classList.add("hidden");
                userDropdownBackdrop.classList.remove("active");
              }
            } else {
              userDropdown.classList.remove("invisible", "opacity-0");
              userDropdown.classList.add("active");
              if (userDropdownBackdrop) {
                userDropdownBackdrop.classList.remove("hidden");
                userDropdownBackdrop.classList.add("active");
              }
            }
          });

          if (userDropdownBackdrop) {
            userDropdownBackdrop.addEventListener("click", () => {
              userDropdown.classList.add("invisible", "opacity-0");
              userDropdown.classList.remove("active");
              userDropdownBackdrop.classList.add("hidden");
              userDropdownBackdrop.classList.remove("active");
            });
          }

          // Handle dropdown item clicks
          const dropdownItems = userDropdown.querySelectorAll(".dropdown-item");
          dropdownItems.forEach((item) => {
            item.addEventListener("click", (e) => {
              const action = item.getAttribute("data-action");

              userDropdown.classList.add("invisible", "opacity-0");
              userDropdown.classList.remove("active");
              if (userDropdownBackdrop) {
                userDropdownBackdrop.classList.add("hidden");
                userDropdownBackdrop.classList.remove("active");
              }

              if (action === "profile") {
                window.location.href = "/profile";
              } else if (action === "settings") {
                window.location.href = "/settings";
              } else if (action === "logout") {
                // Clear storage and redirect
                localStorage.clear();
                sessionStorage.clear();
                window.location.href = "/auth";
              }
            });
          });
        }
      }

      // Initialize user profile and dropdown
      async function initializeUserProfile() {
        try {
          const response = await fetch("/api/user/settings", {
            headers: {
              "Content-Type": "application/json",
            },
            credentials: "include",
          });

          if (response.ok) {
            const user = await response.json();
            
            // Update user display
            const userName = document.getElementById("userName");
            const userTimezone = document.getElementById("userTimezone");
            const userAvatar = document.getElementById("userAvatar");

            if (userName && user.name) {
              userName.textContent = user.name;
            }

            if (userTimezone && user.timezone) {
              // Convert IANA timezone to GMT format
              let timezoneDisplay = user.timezone;
              if (timezoneDisplay.includes("/") || timezoneDisplay.includes("_")) {
                const timezoneMap = {
                  "Asia/Singapore": "GMT+8",
                  "America/New_York": "GMT-5",
                  "America/Los_Angeles": "GMT-8",
                  "Europe/London": "GMT+0",
                  "Europe/Paris": "GMT+1",
                  "Asia/Tokyo": "GMT+9",
                  "Australia/Sydney": "GMT+10",
                };
                timezoneDisplay = timezoneMap[timezoneDisplay] || "GMT+8";
              }
              userTimezone.textContent = timezoneDisplay;
            }

            if (userAvatar && user.name) {
              const getInitials = (name) => {
                if (!name) return "AD";
                const parts = name.trim().split(" ");
                if (parts.length >= 2) {
                  return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
                }
                return name.substring(0, 2).toUpperCase();
              };

              if (user.profilePictureUrl) {
                userAvatar.innerHTML = `<img src="${user.profilePictureUrl}" alt="${user.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 0;" onerror="this.style.display='none'; this.parentElement.textContent='${getInitials(user.name)}';" />`;
              } else {
                userAvatar.textContent = getInitials(user.name);
              }
            }
          }
        } catch (error) {
          console.error("Error fetching user profile:", error);
        }
      }

      // Initialize Lucide icons and dropdown
      document.addEventListener("DOMContentLoaded", async () => {
        if (window.lucide?.createIcons) {
          window.lucide.createIcons();
        }
        
        await initializeUserProfile();
        initializeUserDropdown();

        // Navbar scroll handler
        const header = document.getElementById("mainHeader");
        function handleNavbarScroll() {
          const scrollThreshold = 20;
          const scrollY = window.scrollY || window.pageYOffset;
          if (scrollY > scrollThreshold) {
            header?.classList.add("scrolled");
          } else {
            header?.classList.remove("scrolled");
          }
        }

        window.addEventListener("scroll", () => {
          requestAnimationFrame(handleNavbarScroll);
        });
        handleNavbarScroll();
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="../scripts/admin/admin.js"></script>
  </body>
</html>

